{
  "contract_name": "invoice.contract.v1",
  "version": 1,
  "canonical_schema_ref": "invoice.canonical.v1.schema.json",
  "hitl_schema_ref": "invoice.hitl_view.v1.schema.json",
  "mappings": {
    "di_to_canonical": {
      "InvoiceId": "invoice_number",
      "InvoiceDate": "invoice_date",
      "InvoiceType": "invoice_type",
      "ReferenceNumber": "reference_number",
      "DueDate": "due_date",
      "ShippingDate": "shipping_date",
      "DeliveryDate": "delivery_date",
      "VendorName": "vendor_name",
      "VendorId": "vendor_id",
      "VendorPhoneNumber": "vendor_phone",
      "VendorPhone": "vendor_phone",
      "VendorFax": "vendor_fax",
      "VendorFaxNumber": "vendor_fax",
      "VendorEmail": "vendor_email",
      "VendorWebsite": "vendor_website",
      "VendorAddress": "vendor_address",
      "BusinessNumber": "business_number",
      "GSTNumber": "gst_number",
      "QSTNumber": "qst_number",
      "PSTNumber": "pst_number",
      "CustomerName": "customer_name",
      "CustomerId": "customer_id",
      "CustomerPhone": "customer_phone",
      "CustomerEmail": "customer_email",
      "CustomerFax": "customer_fax",
      "CustomerAddress": "bill_to_address",
      "BillToAddress": "bill_to_address",
      "RemitToAddress": "remit_to_address",
      "RemittanceAddress": "remit_to_address",
      "RemitToName": "remit_to_name",
      "Entity": "entity",
      "ContractId": "contract_id",
      "StandingOfferNumber": "standing_offer_number",
      "PurchaseOrder": "po_number",
      "PONumber": "po_number",
      "ServiceStartDate": "period_start",
      "ServiceEndDate": "period_end",
      "SubTotal": "subtotal",
      "DiscountAmount": "discount_amount",
      "ShippingAmount": "shipping_amount",
      "HandlingFee": "handling_fee",
      "DepositAmount": "deposit_amount",
      "GSTAmount": "gst_amount",
      "GSTRate": "gst_rate",
      "HSTAmount": "hst_amount",
      "HSTRate": "hst_rate",
      "QSTAmount": "qst_amount",
      "QSTRate": "qst_rate",
      "PSTAmount": "pst_amount",
      "PSTRate": "pst_rate",
      "TotalTax": "tax_amount",
      "InvoiceTotal": "total_amount",
      "CurrencyCode": "currency",
      "Currency": "currency",
      "PaymentTerm": "payment_terms",
      "PaymentTerms": "payment_terms",
      "PaymentMethod": "payment_method",
      "PaymentDueUpon": "payment_due_upon",
      "TaxRegistrationNumber": "tax_registration_number",
      "SalesTaxNumber": "tax_registration_number"
    },
    "legacy_to_canonical": {
      "invoice_id": "invoice_number",
      "invoice_total": "total_amount",
      "total_tax": "tax_amount",
      "purchase_order": "po_number",
      "payment_term": "payment_terms"
    }
  },
  "confidence_policy": {
    "low_conf_threshold": 0.75,
    "required_fields": [
      "invoice_number",
      "invoice_date",
      "vendor_name",
      "total_amount"
    ],
    "important_fields": [
      "invoice_number",
      "invoice_date",
      "total_amount",
      "vendor_name",
      "subtotal",
      "tax_amount"
    ],
    "overall_confidence_weights": {
      "invoice_number": 2.0,
      "invoice_date": 2.0,
      "total_amount": 3.0,
      "vendor_name": 2.0,
      "subtotal": 1.5,
      "tax_amount": 1.5
    }
  },
  "overlay_policy": {
    "enable_field_locations": true,
    "coordinate_space": "normalized",
    "max_regions_per_field": 10
  },
  "fields": {
    "invoice_number": {
      "type": "string",
      "required": true,
      "nullable": true,
      "parsers": [
        "strip",
        "normalize_whitespace"
      ],
      "di_fields": [
        "InvoiceId"
      ],
      "legacy_fields": [
        "invoice_id"
      ],
      "confidence_required": true,
      "match_role": "primary_key",
      "overlay_role": "header_field",
      "description": "Vendor invoice identifier (not database id)."
    },
    "invoice_date": {
      "type": "date",
      "required": true,
      "nullable": true,
      "parsers": [
        "parse_date_iso"
      ],
      "di_fields": [
        "InvoiceDate"
      ],
      "legacy_fields": [],
      "confidence_required": true,
      "match_role": "date_key",
      "overlay_role": "header_field"
    },
    "due_date": {
      "type": "date",
      "required": false,
      "nullable": true,
      "parsers": [
        "parse_date_iso"
      ],
      "di_fields": [
        "DueDate"
      ],
      "legacy_fields": [],
      "confidence_required": false,
      "match_role": "date_key",
      "overlay_role": "header_field"
    },
    "vendor_name": {
      "type": "string",
      "required": true,
      "nullable": true,
      "parsers": [
        "strip",
        "normalize_whitespace"
      ],
      "di_fields": [
        "VendorName"
      ],
      "legacy_fields": [],
      "confidence_required": true,
      "match_role": "vendor_key",
      "overlay_role": "header_field"
    },
    "vendor_id": {
      "type": "string",
      "required": false,
      "nullable": true,
      "parsers": [
        "strip"
      ],
      "di_fields": [
        "VendorId"
      ],
      "legacy_fields": [],
      "match_role": "vendor_key",
      "overlay_role": "header_field"
    },
    "vendor_phone": {
      "type": "string",
      "required": false,
      "nullable": true,
      "parsers": [
        "strip",
        "normalize_whitespace"
      ],
      "di_fields": [
        "VendorPhoneNumber",
        "VendorPhone"
      ],
      "legacy_fields": [],
      "match_role": "vendor_key",
      "overlay_role": "header_field"
    },
    "customer_name": {
      "type": "string",
      "required": false,
      "nullable": true,
      "parsers": [
        "strip",
        "normalize_whitespace"
      ],
      "di_fields": [
        "CustomerName"
      ],
      "legacy_fields": [],
      "match_role": "secondary_key",
      "overlay_role": "header_field"
    },
    "customer_id": {
      "type": "string",
      "required": false,
      "nullable": true,
      "parsers": [
        "strip"
      ],
      "di_fields": [
        "CustomerId"
      ],
      "legacy_fields": [],
      "match_role": "secondary_key",
      "overlay_role": "header_field"
    },
    "po_number": {
      "type": "string",
      "required": false,
      "nullable": true,
      "parsers": [
        "strip",
        "normalize_whitespace"
      ],
      "di_fields": [
        "PurchaseOrder",
        "PONumber"
      ],
      "legacy_fields": [
        "purchase_order"
      ],
      "match_role": "reference_key",
      "overlay_role": "header_field"
    },
    "contract_id": {
      "type": "string",
      "required": false,
      "nullable": true,
      "parsers": [
        "strip"
      ],
      "di_fields": [
        "ContractId"
      ],
      "legacy_fields": [],
      "match_role": "reference_key",
      "overlay_role": "header_field"
    },
    "standing_offer_number": {
      "type": "string",
      "required": false,
      "nullable": true,
      "parsers": [
        "strip",
        "normalize_whitespace"
      ],
      "di_fields": [
        "StandingOfferNumber"
      ],
      "legacy_fields": [
        "standing_offer_number"
      ],
      "match_role": "reference_key",
      "overlay_role": "header_field"
    },
    "period_start": {
      "type": "date",
      "required": false,
      "nullable": true,
      "parsers": [
        "parse_date_iso"
      ],
      "di_fields": [
        "ServiceStartDate"
      ],
      "legacy_fields": [],
      "match_role": "date_key",
      "overlay_role": "header_field"
    },
    "period_end": {
      "type": "date",
      "required": false,
      "nullable": true,
      "parsers": [
        "parse_date_iso"
      ],
      "di_fields": [
        "ServiceEndDate"
      ],
      "legacy_fields": [],
      "match_role": "date_key",
      "overlay_role": "header_field"
    },
    "subtotal": {
      "type": "decimal_string",
      "required": false,
      "nullable": true,
      "parsers": [
        "parse_decimal_currency"
      ],
      "di_fields": [
        "SubTotal"
      ],
      "legacy_fields": [],
      "match_role": "amount_key",
      "overlay_role": "header_field"
    },
    "tax_amount": {
      "type": "decimal_string",
      "required": false,
      "nullable": true,
      "parsers": [
        "parse_decimal_currency"
      ],
      "di_fields": [
        "TotalTax"
      ],
      "legacy_fields": [
        "total_tax"
      ],
      "match_role": "amount_key",
      "overlay_role": "header_field"
    },
    "total_amount": {
      "type": "decimal_string",
      "required": true,
      "nullable": true,
      "parsers": [
        "parse_decimal_currency"
      ],
      "di_fields": [
        "InvoiceTotal"
      ],
      "legacy_fields": [
        "invoice_total"
      ],
      "confidence_required": true,
      "match_role": "amount_key",
      "overlay_role": "header_field"
    },
    "currency": {
      "type": "string",
      "required": true,
      "nullable": true,
      "parsers": [
        "strip"
      ],
      "di_fields": [
        "CurrencyCode",
        "Currency"
      ],
      "legacy_fields": [],
      "match_role": "non_matchable",
      "overlay_role": "header_field"
    },
    "payment_terms": {
      "type": "string",
      "required": false,
      "nullable": true,
      "parsers": [
        "strip",
        "normalize_whitespace"
      ],
      "di_fields": [
        "PaymentTerm",
        "PaymentTerms"
      ],
      "legacy_fields": [
        "payment_term"
      ],
      "match_role": "non_matchable",
      "overlay_role": "header_field"
    },
    "acceptance_percentage": {
      "type": "decimal_string",
      "required": false,
      "nullable": true,
      "parsers": [
        "parse_decimal_currency"
      ],
      "di_fields": [
        "AcceptancePercentage"
      ],
      "legacy_fields": [],
      "match_role": "non_matchable",
      "overlay_role": "header_field"
    },
    "tax_registration_number": {
      "type": "string",
      "required": false,
      "nullable": true,
      "parsers": [
        "strip",
        "normalize_whitespace"
      ],
      "di_fields": [
        "TaxRegistrationNumber",
        "SalesTaxNumber"
      ],
      "legacy_fields": [],
      "match_role": "vendor_key",
      "overlay_role": "header_field"
    },
    "vendor_address": {
      "type": "object",
      "required": false,
      "nullable": true,
      "parsers": [
        "identity"
      ],
      "di_fields": [
        "VendorAddress"
      ],
      "legacy_fields": [],
      "match_role": "vendor_key",
      "overlay_role": "address_field"
    },
    "bill_to_address": {
      "type": "object",
      "required": false,
      "nullable": true,
      "parsers": [
        "identity"
      ],
      "di_fields": [
        "CustomerAddress",
        "BillToAddress"
      ],
      "legacy_fields": [],
      "match_role": "secondary_key",
      "overlay_role": "address_field"
    },
    "remit_to_address": {
      "type": "object",
      "required": false,
      "nullable": true,
      "parsers": [
        "identity"
      ],
      "di_fields": [
        "RemitToAddress",
        "RemittanceAddress"
      ],
      "legacy_fields": [],
      "match_role": "vendor_key",
      "overlay_role": "address_field"
    },
    "remit_to_name": {
      "type": "string",
      "required": false,
      "nullable": true,
      "parsers": [
        "strip",
        "normalize_whitespace"
      ],
      "di_fields": [
        "RemitToName"
      ],
      "legacy_fields": [],
      "match_role": "vendor_key",
      "overlay_role": "header_field"
    },
    "vendor_fax": {
      "type": "string",
      "required": false,
      "nullable": true,
      "parsers": [
        "strip",
        "normalize_whitespace"
      ],
      "di_fields": [
        "VendorFax",
        "VendorFaxNumber"
      ],
      "legacy_fields": [],
      "match_role": "vendor_key",
      "overlay_role": "header_field"
    },
    "customer_email": {
      "type": "string",
      "required": false,
      "nullable": true,
      "parsers": [
        "strip",
        "normalize_whitespace"
      ],
      "di_fields": [
        "CustomerEmail"
      ],
      "legacy_fields": [],
      "match_role": "secondary_key",
      "overlay_role": "header_field"
    },
    "qst_amount": {
      "type": "decimal_string",
      "required": false,
      "nullable": true,
      "parsers": [
        "parse_decimal_currency"
      ],
      "di_fields": [
        "QSTAmount"
      ],
      "legacy_fields": [],
      "match_role": "amount_key",
      "overlay_role": "header_field"
    },
    "vendor_website": {
      "type": "string",
      "required": false,
      "nullable": true,
      "parsers": [
        "strip",
        "normalize_whitespace"
      ],
      "di_fields": [
        "VendorWebsite"
      ],
      "legacy_fields": [],
      "match_role": "vendor_key",
      "overlay_role": "header_field"
    },
    "qst_number": {
      "type": "string",
      "required": false,
      "nullable": true,
      "parsers": [
        "strip",
        "normalize_whitespace"
      ],
      "di_fields": [
        "QSTNumber"
      ],
      "legacy_fields": [],
      "match_role": "non_matchable",
      "overlay_role": "header_field"
    },
    "qst_rate": {
      "type": "decimal_string",
      "required": false,
      "nullable": true,
      "parsers": [
        "parse_decimal_currency"
      ],
      "di_fields": [
        "QSTRate"
      ],
      "legacy_fields": [],
      "match_role": "amount_key",
      "overlay_role": "header_field"
    },
    "vendor_email": {
      "type": "string",
      "required": false,
      "nullable": true,
      "parsers": [
        "strip",
        "normalize_whitespace"
      ],
      "di_fields": [
        "VendorEmail"
      ],
      "legacy_fields": [],
      "match_role": "vendor_key",
      "overlay_role": "header_field"
    },
    "customer_phone": {
      "type": "string",
      "required": false,
      "nullable": true,
      "parsers": [
        "strip",
        "normalize_whitespace"
      ],
      "di_fields": [
        "CustomerPhone"
      ],
      "legacy_fields": [],
      "match_role": "secondary_key",
      "overlay_role": "header_field"
    },
    "pst_rate": {
      "type": "decimal_string",
      "required": false,
      "nullable": true,
      "parsers": [
        "parse_decimal_currency"
      ],
      "di_fields": [
        "PSTRate"
      ],
      "legacy_fields": [],
      "match_role": "amount_key",
      "overlay_role": "header_field"
    },
    "discount_amount": {
      "type": "decimal_string",
      "required": false,
      "nullable": true,
      "parsers": [
        "parse_decimal_currency"
      ],
      "di_fields": [
        "DiscountAmount"
      ],
      "legacy_fields": [],
      "match_role": "amount_key",
      "overlay_role": "header_field"
    },
    "hst_amount": {
      "type": "decimal_string",
      "required": false,
      "nullable": true,
      "parsers": [
        "parse_decimal_currency"
      ],
      "di_fields": [
        "HSTAmount"
      ],
      "legacy_fields": [],
      "match_role": "amount_key",
      "overlay_role": "header_field"
    },
    "entity": {
      "type": "string",
      "required": false,
      "nullable": true,
      "parsers": [
        "strip",
        "normalize_whitespace"
      ],
      "di_fields": [
        "Entity"
      ],
      "legacy_fields": [],
      "match_role": "non_matchable",
      "overlay_role": "header_field"
    },
    "invoice_type": {
      "type": "string",
      "required": false,
      "nullable": true,
      "parsers": [
        "strip",
        "normalize_whitespace"
      ],
      "di_fields": [
        "InvoiceType"
      ],
      "legacy_fields": [],
      "match_role": "non_matchable",
      "overlay_role": "header_field"
    },
    "reference_number": {
      "type": "string",
      "required": false,
      "nullable": true,
      "parsers": [
        "strip",
        "normalize_whitespace"
      ],
      "di_fields": [
        "ReferenceNumber"
      ],
      "legacy_fields": [],
      "match_role": "non_matchable",
      "overlay_role": "header_field"
    },
    "gst_rate": {
      "type": "decimal_string",
      "required": false,
      "nullable": true,
      "parsers": [
        "parse_decimal_currency"
      ],
      "di_fields": [
        "GSTRate"
      ],
      "legacy_fields": [],
      "match_role": "amount_key",
      "overlay_role": "header_field"
    },
    "deposit_amount": {
      "type": "decimal_string",
      "required": false,
      "nullable": true,
      "parsers": [
        "parse_decimal_currency"
      ],
      "di_fields": [
        "DepositAmount"
      ],
      "legacy_fields": [],
      "match_role": "amount_key",
      "overlay_role": "header_field"
    },
    "gst_number": {
      "type": "string",
      "required": false,
      "nullable": true,
      "parsers": [
        "strip",
        "normalize_whitespace"
      ],
      "di_fields": [
        "GSTNumber"
      ],
      "legacy_fields": [],
      "match_role": "non_matchable",
      "overlay_role": "header_field"
    },
    "gst_amount": {
      "type": "decimal_string",
      "required": false,
      "nullable": true,
      "parsers": [
        "parse_decimal_currency"
      ],
      "di_fields": [
        "GSTAmount"
      ],
      "legacy_fields": [],
      "match_role": "amount_key",
      "overlay_role": "header_field"
    },
    "pst_number": {
      "type": "string",
      "required": false,
      "nullable": true,
      "parsers": [
        "strip",
        "normalize_whitespace"
      ],
      "di_fields": [
        "PSTNumber"
      ],
      "legacy_fields": [],
      "match_role": "non_matchable",
      "overlay_role": "header_field"
    },
    "pst_amount": {
      "type": "decimal_string",
      "required": false,
      "nullable": true,
      "parsers": [
        "parse_decimal_currency"
      ],
      "di_fields": [
        "PSTAmount"
      ],
      "legacy_fields": [],
      "match_role": "amount_key",
      "overlay_role": "header_field"
    },
    "customer_fax": {
      "type": "string",
      "required": false,
      "nullable": true,
      "parsers": [
        "strip",
        "normalize_whitespace"
      ],
      "di_fields": [
        "CustomerFax"
      ],
      "legacy_fields": [],
      "match_role": "secondary_key",
      "overlay_role": "header_field"
    },
    "business_number": {
      "type": "string",
      "required": false,
      "nullable": true,
      "parsers": [
        "strip",
        "normalize_whitespace"
      ],
      "di_fields": [
        "BusinessNumber"
      ],
      "legacy_fields": [],
      "match_role": "non_matchable",
      "overlay_role": "header_field"
    },
    "payment_due_upon": {
      "type": "string",
      "required": false,
      "nullable": true,
      "parsers": [
        "strip",
        "normalize_whitespace"
      ],
      "di_fields": [
        "PaymentDueUpon"
      ],
      "legacy_fields": [],
      "match_role": "non_matchable",
      "overlay_role": "header_field"
    },
    "handling_fee": {
      "type": "string",
      "required": false,
      "nullable": true,
      "parsers": [
        "strip",
        "normalize_whitespace"
      ],
      "di_fields": [
        "HandlingFee"
      ],
      "legacy_fields": [],
      "match_role": "non_matchable",
      "overlay_role": "header_field"
    },
    "shipping_amount": {
      "type": "decimal_string",
      "required": false,
      "nullable": true,
      "parsers": [
        "parse_decimal_currency"
      ],
      "di_fields": [
        "ShippingAmount"
      ],
      "legacy_fields": [],
      "match_role": "amount_key",
      "overlay_role": "header_field"
    },
    "hst_rate": {
      "type": "decimal_string",
      "required": false,
      "nullable": true,
      "parsers": [
        "parse_decimal_currency"
      ],
      "di_fields": [
        "HSTRate"
      ],
      "legacy_fields": [],
      "match_role": "amount_key",
      "overlay_role": "header_field"
    },
    "payment_method": {
      "type": "string",
      "required": false,
      "nullable": true,
      "parsers": [
        "strip",
        "normalize_whitespace"
      ],
      "di_fields": [
        "PaymentMethod"
      ],
      "legacy_fields": [],
      "match_role": "non_matchable",
      "overlay_role": "header_field"
    }
  },
  "notes": "This contract centralizes DI->canonical mapping, required/important field policy, and overlay/matching roles for v1. IMPORTANT: FieldExtractor.DI_TO_CANONICAL (in src/extraction/field_extractor.py) is the source of truth for DI field mappings. The di_to_canonical mappings in this contract should match FieldExtractor exactly."
}